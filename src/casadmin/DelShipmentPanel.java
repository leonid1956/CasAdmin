package casadmin;

import java.io.*;
import java.math.BigDecimal;
import java.util.*;
import javax.swing.*;
import javax.swing.text.BadLocationException;

public class DelShipmentPanel extends javax.swing.JPanel {

    public DelShipmentPanel() {
        initComponents();
        Date d = new Date();
        dcData.setDate(d);
        tfIdCas.setText("");
        dataPanel.setVisible(false);
        butDelete.setVisible(false);
        FileChooser.setVisible(false);
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jSplitPane1 = new javax.swing.JSplitPane();
        upPanel = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        dcData = new com.toedter.calendar.JDateChooser();
        jLabel66 = new javax.swing.JLabel();
        tfIdCas = new javax.swing.JTextField();
        jbShowCustomers = new javax.swing.JButton();
        jbShow = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        hhOd = new javax.swing.JComboBox();
        mmOd = new javax.swing.JComboBox();
        ssOd = new javax.swing.JComboBox();
        hhDo = new javax.swing.JComboBox();
        mmDo = new javax.swing.JComboBox();
        ssDo = new javax.swing.JComboBox();
        butFromFile = new javax.swing.JButton();
        downPanel = new javax.swing.JPanel();
        dataPanel = new javax.swing.JPanel();
        scrollTablePanel = new javax.swing.JScrollPane();
        table = new javax.swing.JTable();
        scrollTextFieldPanel = new javax.swing.JScrollPane();
        textField = new javax.swing.JTextArea();
        butDelete = new javax.swing.JButton();
        FileChooser = new javax.swing.JFileChooser();

        setName("Form"); // NOI18N
        setLayout(new java.awt.GridLayout(1, 0));

        jSplitPane1.setDividerLocation(100);
        jSplitPane1.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);
        jSplitPane1.setName("jSplitPane1"); // NOI18N

        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(casadmin.CasAdminApp.class).getContext().getResourceMap(DelShipmentPanel.class);
        upPanel.setBackground(resourceMap.getColor("upPanel.background")); // NOI18N
        upPanel.setName("upPanel"); // NOI18N
        upPanel.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jPanel2.setBackground(resourceMap.getColor("jPanel2.background")); // NOI18N
        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("jPanel2.border.title"))); // NOI18N
        jPanel2.setName("jPanel2"); // NOI18N
        jPanel2.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel1.setText(resourceMap.getString("jLabel1.text")); // NOI18N
        jLabel1.setName("jLabel1"); // NOI18N
        jPanel2.add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 20, -1, 20));

        dcData.setDateFormatString(resourceMap.getString("dcData.dateFormatString")); // NOI18N
        dcData.setName("dcData"); // NOI18N
        jPanel2.add(dcData, new org.netbeans.lib.awtextra.AbsoluteConstraints(90, 20, 120, 20));

        jLabel66.setText(resourceMap.getString("jLabel66.text")); // NOI18N
        jLabel66.setName("jLabel66"); // NOI18N
        jPanel2.add(jLabel66, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 50, -1, -1));

        tfIdCas.setName("tfIdCas"); // NOI18N
        jPanel2.add(tfIdCas, new org.netbeans.lib.awtextra.AbsoluteConstraints(90, 50, 80, 20));

        jbShowCustomers.setText(resourceMap.getString("jbShowCustomers.text")); // NOI18N
        jbShowCustomers.setName("jbShowCustomers"); // NOI18N
        jbShowCustomers.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbShowCustomersActionPerformed(evt);
            }
        });
        jPanel2.add(jbShowCustomers, new org.netbeans.lib.awtextra.AbsoluteConstraints(170, 50, 40, -1));

        jbShow.setText(resourceMap.getString("jbShow.text")); // NOI18N
        jbShow.setName("jbShow"); // NOI18N
        jbShow.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbShowActionPerformed(evt);
            }
        });
        jPanel2.add(jbShow, new org.netbeans.lib.awtextra.AbsoluteConstraints(420, 47, 70, -1));

        jLabel2.setText(resourceMap.getString("jLabel2.text")); // NOI18N
        jLabel2.setName("jLabel2"); // NOI18N
        jPanel2.add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 20, -1, 20));

        jLabel3.setText(resourceMap.getString("jLabel3.text")); // NOI18N
        jLabel3.setName("jLabel3"); // NOI18N
        jPanel2.add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 50, 60, -1));

        hhOd.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23" }));
        hhOd.setName("hhOd"); // NOI18N
        jPanel2.add(hhOd, new org.netbeans.lib.awtextra.AbsoluteConstraints(290, 20, 40, -1));

        mmOd.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59" }));
        mmOd.setName("mmOd"); // NOI18N
        jPanel2.add(mmOd, new org.netbeans.lib.awtextra.AbsoluteConstraints(330, 20, 40, -1));

        ssOd.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59" }));
        ssOd.setName("ssOd"); // NOI18N
        jPanel2.add(ssOd, new org.netbeans.lib.awtextra.AbsoluteConstraints(370, 20, 40, -1));

        hhDo.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23" }));
        hhDo.setSelectedIndex(23);
        hhDo.setName("hhDo"); // NOI18N
        jPanel2.add(hhDo, new org.netbeans.lib.awtextra.AbsoluteConstraints(290, 50, 40, -1));

        mmDo.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59" }));
        mmDo.setSelectedIndex(59);
        mmDo.setName("mmDo"); // NOI18N
        jPanel2.add(mmDo, new org.netbeans.lib.awtextra.AbsoluteConstraints(330, 50, 40, -1));

        ssDo.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59" }));
        ssDo.setSelectedIndex(59);
        ssDo.setName("ssDo"); // NOI18N
        jPanel2.add(ssDo, new org.netbeans.lib.awtextra.AbsoluteConstraints(370, 50, 40, -1));

        butFromFile.setText(resourceMap.getString("butFromFile.text")); // NOI18N
        butFromFile.setName("butFromFile"); // NOI18N
        butFromFile.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                butFromFileActionPerformed(evt);
            }
        });
        jPanel2.add(butFromFile, new org.netbeans.lib.awtextra.AbsoluteConstraints(420, 20, 70, -1));

        upPanel.add(jPanel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 10, 500, 80));

        jSplitPane1.setTopComponent(upPanel);

        downPanel.setBackground(resourceMap.getColor("downPanel.background")); // NOI18N
        downPanel.setName("downPanel"); // NOI18N
        downPanel.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        dataPanel.setName("dataPanel"); // NOI18N
        dataPanel.setLayout(new java.awt.CardLayout());

        scrollTablePanel.setName("scrollTablePanel"); // NOI18N

        table.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        table.setName("table"); // NOI18N
        scrollTablePanel.setViewportView(table);

        dataPanel.add(scrollTablePanel, "card2");

        scrollTextFieldPanel.setName("scrollTextFieldPanel"); // NOI18N

        textField.setColumns(20);
        textField.setFont(resourceMap.getFont("textField.font")); // NOI18N
        textField.setRows(5);
        textField.setName("textField"); // NOI18N
        scrollTextFieldPanel.setViewportView(textField);

        dataPanel.add(scrollTextFieldPanel, "card3");

        downPanel.add(dataPanel, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, 660, 390));

        butDelete.setText(resourceMap.getString("butDelete.text")); // NOI18N
        butDelete.setName("butDelete"); // NOI18N
        butDelete.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                butDeleteActionPerformed(evt);
            }
        });
        downPanel.add(butDelete, new org.netbeans.lib.awtextra.AbsoluteConstraints(670, 350, 110, 30));

        FileChooser.setFileSelectionMode(javax.swing.JFileChooser.FILES_AND_DIRECTORIES);
        FileChooser.setName("FileChooser"); // NOI18N
        downPanel.add(FileChooser, new org.netbeans.lib.awtextra.AbsoluteConstraints(140, 0, 660, 390));

        jSplitPane1.setRightComponent(downPanel);

        add(jSplitPane1);
    }// </editor-fold>//GEN-END:initComponents

    private void jbShowCustomersActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbShowCustomersActionPerformed
        // Naciśnięty przycisk "?" w polu "ID CAS"
        // Proponujemy zaznaczyć klientów do przegłądania
        SelectCustomerDialog frame = new SelectCustomerDialog(null, true, true, "","");
        frame.setTitle("Zaznacz ID_CUST klientów, którzycz chcesz obejrzeć");
        frame.setVisible(true);
        // Wyświetlamy Id Cust, które chcemy przeglądać
        tfIdCas.setText(((SelectCustomerDialog) frame).selectedID_CUST);
        tfIdCas.repaint();
    }//GEN-LAST:event_jbShowCustomersActionPerformed

    private String getIdSap(String p_sIdCas){
        String IdSap = "";
        int len = p_sIdCas.length();
        if ((len < 4) || (len > 5) || !YPFunctions.isInteger(p_sIdCas))
            YPFunctions.showErrorMessage("Nie prawidłowy Id Cas");
//            JOptionPane.showMessageDialog(null, "Nie prawidłowy Id Cas", "Błąd",JOptionPane.ERROR_MESSAGE);
        else {
            int iIdCas = Integer.parseInt(p_sIdCas);
            IdSap = GlobalData.oraSession.selectString("Select ID_SAP from customers where id_cust=?",
                        new Vector(Arrays.asList(iIdCas)),
                        "");
            if (IdSap.equals(""))
                YPFunctions.showErrorMessage("Nie ma takiego numeru ID CAS");
//                JOptionPane.showMessageDialog(null, "Nie ma takiego numeru ID CAS", "Błąd",JOptionPane.ERROR_MESSAGE);
        }
        return IdSap;
    }


    private void jbShowActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbShowActionPerformed
        // Naciśnięty przycisk "Pokaż"
        sIdCas = tfIdCas.getText();
        sIdSap = getIdSap(sIdCas);
        if (sIdSap.equals(""))
            return;
        String currentDate = YPFunctions.DateToString(dcData.getDate());
        String fromDate = currentDate + " " +
                    (String)hhOd.getSelectedItem() + ":" +
                    (String)mmOd.getSelectedItem() + ":" +
                    (String)ssOd.getSelectedItem();
        String toDate = currentDate + " " +
                    (String)hhDo.getSelectedItem() + ":" +
                    (String)mmDo.getSelectedItem() + ":" +
                    (String)ssDo.getSelectedItem();

        YPFunctions.FillTableFromOra("select date_connect \"Data\", Remote_Addr, Proc_Name," +
                                            "param1 \"Numer LP\", param3 \"Kod\" " +
                                     "from log_comm " +
                                     "where date_connect between to_date(?,'yyyy/MM/dd hh24:mi:ss') and " +
                                                                "to_date(?,'yyyy/MM/dd hh24:mi:ss') and " +
                                           "id_cust=? and " +
                                           "proc_name = ?" + //'SAVE_SHIPMENT'
                                     "order by date_connect desc",
                                     new Vector(Arrays.asList(fromDate,toDate,Integer.parseInt(sIdCas),"SAVE_SHIPMENT")) ,
                                     0,
                                     99999,
                                     table,
                                     new Vector(Arrays.asList(20, 60, 30, 40, 80, 20,20)),
                                     new Vector(),
                                     true,  // z kolumną checkbox'ów jako pierwsza
                                     true,
                                     new Vector(Arrays.asList(0)),
                                     null,
                                     true);
        dataPanel.setVisible(true);
        scrollTablePanel.setVisible(true);
        scrollTextFieldPanel.setVisible(false);
        FileChooser.setVisible(false);
        table.repaint();
        butDelete.setVisible(true);

}//GEN-LAST:event_jbShowActionPerformed

    /**
    * Załadowuje i pokazuje zawartość pliku tekstowego w textField
    **/
    public void showFile(String directory, String filename) {
        if ((filename == null) || (filename.length() == 0)) return;
        File f;
        FileReader in = null;
        try {
            f = new File(directory, filename);
            in = new FileReader(f);
            char[] buffer = new char[4096];
            int len;
            textField.setText("");
            while((len = in.read(buffer)) != -1) {
                String s = new String(buffer, 0, len);
                textField.append(s);
            }
            textField.setCaretPosition(0);
        }
        catch (IOException e) {
            textField.setText(e.getClass().getName() + ": " + e.getMessage());
        }
        finally { try { if (in!=null) in.close(); } catch (IOException e) {} }
    }




    private void butFromFileActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_butFromFileActionPerformed
        sIdCas = tfIdCas.getText();
        sIdSap = getIdSap(sIdCas);
        if (sIdSap.equals(""))
            return;
        dataPanel.setVisible(false);
        scrollTablePanel.setVisible(false);
        scrollTextFieldPanel.setVisible(false);
        butDelete.setVisible(false);
        FileChooser.setVisible(true);

        int returnVal = FileChooser.showOpenDialog(this);
        if(returnVal != JFileChooser.APPROVE_OPTION) {
            YPFunctions.showErrorMessage("Nie wybrany żaden plik");
//            JOptionPane.showMessageDialog(null, "Nie wybrany żaden plik");
            return;
        }

        FileChooser.setVisible(true);
        dataPanel.setVisible(true);

        scrollTablePanel.setVisible(false);
        scrollTextFieldPanel.setVisible(true);

        showFile(FileChooser.getCurrentDirectory().toString(),
                 FileChooser.getSelectedFile().getName());

        butDelete.setVisible(true);
    }//GEN-LAST:event_butFromFileActionPerformed

    private String CodedNumInst(String p_idCas, String p_idSAP)
    {
        String source = "0123456789";
        String dest   = "7945610328";

        String s = p_idCas + p_idSAP;
        String result = "";
        for (int i = s.length()-1; i >= 0; i--)
        {
            String sub =  s.substring(i,i+1);
            int p = source.indexOf(sub);
            result += dest.substring(p,p+1);
        }
        return result;
    }



    private void butDeleteActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_butDeleteActionPerformed
        int count = 0;
        String shipments = "";
        sCodedIdCas = CodedNumInst(sIdCas, sIdSap);
        BigDecimal bd = new BigDecimal(sCodedIdCas);
        if (scrollTablePanel.isVisible())
        {
            for (int i = 0; i < table.getRowCount(); i++)
            {
                if ((Boolean) table.getValueAt(i, 0)) {
                     String shipment_Id = YPFunctions.strGet(table,i, 4);
                     GlobalData.oraSession.executeProcedure(
                             "CAS_COMM.DEL_SHIPMENT(?,?)",
                              new Vector(Arrays.asList(bd,shipment_Id)));
                     if (shipments.length() < 3980) 
                         shipments += shipment_Id + ",";
                     count ++;
                }
            }
        }
        else
        {
            String shipment_Id;
            String text = textField.getText();
            for (int i=0; i < textField.getLineCount(); i++) {
                try {
                    int start = textField.getLineStartOffset(i);
                    int end = textField.getLineEndOffset(i);
                    String line = text.substring(start, end).trim();
                    shipment_Id = "";
                    if (line.length() > 0) {
                        if (line.length() < 15)
                            shipment_Id = YPFunctions.getTokenAt(0,line,",","");
                        else if (line.substring(0, 3).equals("DHL"))
                            shipment_Id = YPFunctions.getTokenAt(3,line,";","");
                    }
                    if (shipment_Id.length() == 11) {
                        GlobalData.oraSession.executeProcedure(
                                "CAS_COMM.DEL_SHIPMENT(?,?)",
                                 new Vector(Arrays.asList(bd,shipment_Id)));
                     if (shipments.length() < 3980) 
                         shipments += shipment_Id + ",";
                        count ++;
                    }

                } catch (BadLocationException ex) {
                }

            }
        }
        GlobalData.oraSession.SaveLog("Usuwanie listów przewozowych Cust_Id=" + sIdCas, shipments);
        YPFunctions.showMessage("Usunięto " + count + " listów przewozowych","");
    }//GEN-LAST:event_butDeleteActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JFileChooser FileChooser;
    private javax.swing.JButton butDelete;
    private javax.swing.JButton butFromFile;
    private javax.swing.JPanel dataPanel;
    private com.toedter.calendar.JDateChooser dcData;
    private javax.swing.JPanel downPanel;
    private javax.swing.JComboBox hhDo;
    private javax.swing.JComboBox hhOd;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel66;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JSplitPane jSplitPane1;
    private javax.swing.JButton jbShow;
    private javax.swing.JButton jbShowCustomers;
    private javax.swing.JComboBox mmDo;
    private javax.swing.JComboBox mmOd;
    private javax.swing.JScrollPane scrollTablePanel;
    private javax.swing.JScrollPane scrollTextFieldPanel;
    private javax.swing.JComboBox ssDo;
    private javax.swing.JComboBox ssOd;
    private javax.swing.JTable table;
    private javax.swing.JTextArea textField;
    private javax.swing.JTextField tfIdCas;
    private javax.swing.JPanel upPanel;
    // End of variables declaration//GEN-END:variables
    private String sIdCas;
    private String sIdSap;
    private String sCodedIdCas;

}
