/*
 * ShipmentActivityPanel.java
 *
 * Created on 31 październik 2008, 09:48
 */
package casadmin;

import java.awt.Dimension;
import java.util.*;

public class ReportCountByIdCustPanel extends javax.swing.JPanel {

    /** Creates new form ShipmentActivityPanel */
    public ReportCountByIdCustPanel() {
        initComponents();
        Date d = new Date();
        dcOdDatyNadania.setDate(d);
        dcDoDatyNadania.setDate(d);
        fillComboOpiekun();

    }

    private void fillComboOpiekun() {
        if (GlobalData.v_allUsers.isEmpty())
                 GlobalData.v_allUsers =
                        GlobalData.oraSession.selectOneColumnToVector(
                        "Select user_name from cas_users where active='T' order by user_name",
                        null);

        comboOpiekun.removeAllItems();
        comboOpiekun.addItem("*.*");
        Iterator it = GlobalData.v_allUsers.iterator();
        while (it.hasNext())
               comboOpiekun.addItem((String) it.next());
        comboOpiekun.setSelectedItem("*.*");
    }


    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jSplitPane1 = new javax.swing.JSplitPane();
        upPanel = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        dcOdDatyNadania = new com.toedter.calendar.JDateChooser();
        jLabel66 = new javax.swing.JLabel();
        tfIdCas = new javax.swing.JTextField();
        jbShowCustomers = new javax.swing.JButton();
        jbShow = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();
        dcDoDatyNadania = new com.toedter.calendar.JDateChooser();
        jLabel3 = new javax.swing.JLabel();
        comboOpiekun = new javax.swing.JComboBox();
        downPanel = new javax.swing.JScrollPane();
        tableData = new javax.swing.JTable();

        setName("Form"); // NOI18N
        setLayout(new java.awt.GridLayout(1, 0));

        jSplitPane1.setDividerLocation(100);
        jSplitPane1.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);
        jSplitPane1.setName("jSplitPane1"); // NOI18N

        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(casadmin.CasAdminApp.class).getContext().getResourceMap(ReportCountByIdCustPanel.class);
        upPanel.setBackground(resourceMap.getColor("upPanel.background")); // NOI18N
        upPanel.setName("upPanel"); // NOI18N
        upPanel.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jPanel2.setBackground(resourceMap.getColor("jPanel2.background")); // NOI18N
        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("jPanel2.border.title"))); // NOI18N
        jPanel2.setName("jPanel2"); // NOI18N
        jPanel2.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel1.setText(resourceMap.getString("jLabel1.text")); // NOI18N
        jLabel1.setName("jLabel1"); // NOI18N
        jPanel2.add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 20, -1, 20));

        dcOdDatyNadania.setDateFormatString(resourceMap.getString("dcOdDatyNadania.dateFormatString")); // NOI18N
        dcOdDatyNadania.setName("dcOdDatyNadania"); // NOI18N
        jPanel2.add(dcOdDatyNadania, new org.netbeans.lib.awtextra.AbsoluteConstraints(110, 20, 100, 20));

        jLabel66.setText(resourceMap.getString("jLabel66.text")); // NOI18N
        jLabel66.setName("jLabel66"); // NOI18N
        jPanel2.add(jLabel66, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 50, -1, 20));

        tfIdCas.setName("tfIdCas"); // NOI18N
        jPanel2.add(tfIdCas, new org.netbeans.lib.awtextra.AbsoluteConstraints(310, 50, 110, 20));

        jbShowCustomers.setText(resourceMap.getString("jbShowCustomers.text")); // NOI18N
        jbShowCustomers.setName("jbShowCustomers"); // NOI18N
        jbShowCustomers.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbShowCustomersActionPerformed(evt);
            }
        });
        jPanel2.add(jbShowCustomers, new org.netbeans.lib.awtextra.AbsoluteConstraints(420, 50, 40, -1));

        jbShow.setText(resourceMap.getString("jbShow.text")); // NOI18N
        jbShow.setName("jbShow"); // NOI18N
        jbShow.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbShowActionPerformed(evt);
            }
        });
        jPanel2.add(jbShow, new org.netbeans.lib.awtextra.AbsoluteConstraints(470, 20, 100, 50));

        jLabel2.setText(resourceMap.getString("jLabel2.text")); // NOI18N
        jLabel2.setName("jLabel2"); // NOI18N
        jPanel2.add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 50, -1, 20));

        dcDoDatyNadania.setDateFormatString(resourceMap.getString("dcDoDatyNadania.dateFormatString")); // NOI18N
        dcDoDatyNadania.setName("dcDoDatyNadania"); // NOI18N
        jPanel2.add(dcDoDatyNadania, new org.netbeans.lib.awtextra.AbsoluteConstraints(110, 50, 100, 20));

        jLabel3.setText(resourceMap.getString("jLabel3.text")); // NOI18N
        jLabel3.setName("jLabel3"); // NOI18N
        jPanel2.add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 20, -1, 20));

        comboOpiekun.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        comboOpiekun.setName("comboOpiekun"); // NOI18N
        jPanel2.add(comboOpiekun, new org.netbeans.lib.awtextra.AbsoluteConstraints(310, 20, 150, -1));

        upPanel.add(jPanel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 10, 580, 80));

        jSplitPane1.setTopComponent(upPanel);

        downPanel.setBackground(resourceMap.getColor("downPanel.background")); // NOI18N
        downPanel.setAutoscrolls(true);
        downPanel.setName("downPanel"); // NOI18N

        tableData.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {

            }
        ));
        tableData.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        tableData.setName("tableData"); // NOI18N
        tableData.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tableDataMouseClicked(evt);
            }
        });
        downPanel.setViewportView(tableData);

        jSplitPane1.setRightComponent(downPanel);

        add(jSplitPane1);
    }// </editor-fold>//GEN-END:initComponents

    private void ShowMainQuery(String p_query, int p_start, int p_end) {
        // Wyświetlamy tablicę
        YPFunctions.FillTableFromOra(p_query,
                                     null,
                                     p_start,
                                     p_end,
                                     tableData,
                                     new Vector(Arrays.asList(40, 40, 40, 40, 40, 40, 40, 50, 70, 40)),
                                     new Vector(),
                                     false,  // z kolumną checkbox'ów jako pierwsza
                                     true,
                                     new Vector(),
                                     null,
                                     true);
    }

    private void prepareAndShowMainQuery() {
        // Przygotowujemy warunek dla zapytania SQL

        String subQuery = "";
        String sCasSap = tfIdCas.getText();
        // Jeśli wybrane ID CUST lub ID SAP
        if (! sCasSap.equals("")) {
            String firstToken = YPFunctions.getTokenAt(0, sCasSap, ",", "");
            if (firstToken.length()==7)
                subQuery += " and ds.id_cust in (select id_cust from customers where id_sap in (" +
                              tfIdCas.getText() + "))";
            else
                subQuery += " and ds.id_cust in (" + tfIdCas.getText() + ")";
        }
        
        String opiekun = (String)comboOpiekun.getSelectedItem();
        if ( ! opiekun.equals("*.*"))
            subQuery += " and ds.id_cust in (select id_cust from customers where id_user = (select id_user from cas_users where user_name='"+
                    opiekun + "')) ";


        
        subQuery += " and ds.time between to_date('" +
                          YPFunctions.DateToString(dcOdDatyNadania.getDate()) +
                          " 00:00:00','yyyy/mm/dd hh24:mi:ss')" +
                          " and to_date('" +
                          YPFunctions.DateToString(dcDoDatyNadania.getDate()) +
                          " 23:59:59','yyyy/mm/dd hh24:mi:ss')";

        subQuery = subQuery.substring(4) + " and ds.is_deleted='N' ";

        // Budujemy zapytanie SQL
        String mainQuery = "select grouped_data.*, vC.ID_SAP as \"ID_SAP\", vc.nazwa as \"Nazwa\", VC.USER_NAME as \"Opiekun\" " +
                           "from " +
                              "v_customers vc," +
                              "(select ds.id_cust as \"ID_CUST\"," +
                                  "sum(decode(ds.rodzaj,'AH',1,0)) as \"AH\"," +
                                  "sum(decode(ds.Rodzaj,'09',1,0)) as \"DHL09\"," +
                                  "sum(decode(ds.Rodzaj,'12',1,0)) as \"DHL12\"," +
                                  "sum(decode(ds.Rodzaj,'PW',1,0)) as \"PW\"," +
                                  "sum(decode(ds.Rodzaj,'SM',1,0)) as \"SM\"," +
                                  "sum(decode(ds.u_blp,'x',1,0)) as \"BLP\" " +
                              "from data_shipments ds " + 
                              "where " + subQuery +
                              "group by ds.id_cust) grouped_data " +
                           "where vc.id_cust = grouped_data.id_cust";
        // Odczytujemy ilość rekordów, które trzeba odczytać
            ShowMainQuery(mainQuery, 0, 999999);
    }

    private void jbShowCustomersActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbShowCustomersActionPerformed
        // Naciśnięty przycisk "?" w polu "ID CAS"
        // Proponujemy zaznaczyć klientów do przegłądania
        SelectCustomerDialog frame = new SelectCustomerDialog(null, true, false, "","");
        frame.setTitle("Zaznacz ID_CUST klientów, którzycz chcesz obejrzeć");
        frame.setVisible(true);
        // Wyświetlamy Id Cust, które chcemy przeglądać
        tfIdCas.setText(((SelectCustomerDialog)frame).selectedID_CUST);
        tfIdCas.repaint();

}//GEN-LAST:event_jbShowCustomersActionPerformed

    private void jbShowActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbShowActionPerformed
        // Naciśnięty przycisk "Pokaż"
        // Wyświetlamy zawartość tablicy zgodnie z wybranymi opcjami
        YPFunctions.clearContainer(downPanel);
        this.setCursor(java.awt.Cursor.getPredefinedCursor(java.awt.Cursor.WAIT_CURSOR));
        prepareAndShowMainQuery();
        this.setCursor(java.awt.Cursor.getDefaultCursor());
}//GEN-LAST:event_jbShowActionPerformed

    private void tableDataMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tableDataMouseClicked
        YPFunctions.showPanelAsModalDialog(
                new ShipmentsPanel(
                       dcOdDatyNadania.getDate(),
                       dcDoDatyNadania.getDate(),
                       YPFunctions.strGet(tableData, tableData.getSelectedRow(), 0),
                        ""),
                "Przegląd informacji o przesyłkach",
                new Dimension(1017,700));
    }//GEN-LAST:event_tableDataMouseClicked

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JComboBox comboOpiekun;
    private com.toedter.calendar.JDateChooser dcDoDatyNadania;
    private com.toedter.calendar.JDateChooser dcOdDatyNadania;
    private javax.swing.JScrollPane downPanel;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel66;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JSplitPane jSplitPane1;
    private javax.swing.JButton jbShow;
    private javax.swing.JButton jbShowCustomers;
    private javax.swing.JTable tableData;
    private javax.swing.JTextField tfIdCas;
    private javax.swing.JPanel upPanel;
    // End of variables declaration//GEN-END:variables
 
}
